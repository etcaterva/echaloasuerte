{% extends "base.html" %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% load i18n %}
{% block title %}{{ bom.title|default:bom.DEFAULT_TITLE }} | {% endblock title %}
{#
    MAKE THE EDITION OF SHARE CONFIG WORK
    CLEANUP
#}
{% block extra_head %}
    <script src="{% static 'js/autoGrowArea.js' %}"></script>
    <script src="{% static 'js/favourites.js' %}"></script>
    <script src="{% static 'js/moment.js' %}"></script>
    <script src="{% static 'js/slideSelector.js' %}"></script>
    <link href="{% static 'css/slideSelector.css' %}" rel="stylesheet">
    <script src="{% static 'js/public_draw_manager.js' %}"></script>
    <script src="{% static 'js/chat.js' %}"></script>
    <link href="{% static 'css/chat.css' %}" rel="stylesheet" />

    <script src="{% static 'js/card.js' %}"></script>
    <script src="{% static 'js/coin.js' %}"></script>
    <script src="{% static 'js/dice.js' %}"></script>
    {% block draw_extra_head %}{% endblock draw_extra_head %}
{% endblock extra_head %}
{% block extra_js %}
    //Precaching the images
    {% if bom.draw_type == "CoinDraw" %}
        coin.setup('{{ STATIC_URL }}' + "img/img_coin/");
    {% elif bom.draw_type == "DiceDraw"  %}
        D6.baseUrl = '{{ STATIC_URL }}' + "img/img_dice/"
        D6Animator.getImageBank("", D6.baseUrl);
    {% endif %}
{% endblock extra_js %}
{% block extra_jq_ready %}

    // When fields are focused, all the content is pre-selected
    $('.form-control').click(function() {
        var attr = $(this).hasClass('protected');
        console.log(attr);
        if (typeof attr === typeof undefined || attr === false) {
            $(this).select();
        }
    });

    // Autoresize the title box when window is resized
    autosize = function(){
        var max_width = $("#draw-title-container").width()*2/3;
        $("textarea.autogrow").width(max_width);
        $("textarea.autogrow").autoGrowInput({title:'{{ bom.title|default:bom.DEFAULT_TITLE }}',maxWidth: max_width,minWidth:30,comfortZone:30});
    };

    // Autosize the title box the first time
    autosize();
    $( window ).resize(function() {
        // Autosize when the window is resized
        autosize();
    });

    // Disable submit button after submitting
    $('form').submit(function() {
        $(this).find("button[type='submit']").prop('disabled',true);
        return true;
    });

    $('.accordion').accordion({collapsible: true});

    $('#fav-button').favourites({
            "url_add": "{% url 'ws_add_favorite' %}",
            "url_remove": "{% url 'ws_remove_favorite' %}",
            "user_authenticated": {{ user.is_authenticated|yesno:"true,false" }},
            "draw_id": "{{ bom.pk }}",
            "path_img_star": "{% static "img/star.png" %}",
            "path_img_star_empty": "{% static "img/star-o.png" %}",
            "msg_regsiter": "You need an account to save your favourite draws",
            "msg_toss": "Click on the 'Toss' button to try the draw first"
    });
    {% if bom.is_shared %}
        var bom_last_updated = moment.utc("{{bom.last_updated_time.isoformat}}");
        PublicDraw.url_invite_users = "{% url 'ws_add_users_to_draw' %}";
        $('input#invite-emails').tokenfield({createTokensOnBlur:true, delimiter: [',',' '], inputType: 'email', minWidth: 300});
        PublicDraw.prepare_privacy_selection();
        PublicDraw.settings();

        var chat_containers = $('#chat-frame, #chat-column');
		var chats = chat_containers.chat({
            "is_disabled": {%if user.is_anonymous%} true {% else %} false {% endif %},
            "url_send_message": "{% url 'chat_add_message' %}",
            "url_get_messages": "{% url 'ws_get_draw_details' %}",
            "draw_id": "{{ bom.pk }}",
            "msg_type_your_message": "{% trans 'Type your message here...' %}",
            "msg_login_first": "{% trans 'Please, login or register to be able to use the chat'%}",
            "msg_chat": "{% trans 'Chat' %}",
            "msg_send": "{% trans 'Send' %}"
        });


        var show_chat = function (enable_chat) {
            if(enable_chat) {
                chat_containers.removeClass("chat-disabled");
            } else {
                chat_containers.addClass("chat-disabled");
            }
        };
        show_chat({{bom.enable_chat|yesno:"true,false"}});

        /*
            SETTINGS OPTION: Change privacy
            Confirmation after editing privacy settings
        */
        var bom_password = "{{bom.password}}";
        $('button#save-settings').click(function() {
            $('div#settings-privacy div.feedback').addClass('hide');
            PublicDraw.update_privacy_fields();
            var shared_type = $('input#id_shared_type').val();
            var new_password = $('input#draw_password').val();
            var enable_chat = $("#settings-chat-enabled").prop( "checked");
            var show_in_public_list = $("#settings-show-in-public-list").prop( "checked");
            $.get("{% url 'ws_update_share_settings' %}", {
                    draw_id: "{{bom.pk}}",
                    password: bom_password,
                    new_password: new_password,
                    shared_type: shared_type,
                    enable_chat: enable_chat,
                    show_in_public_list: show_in_public_list
            }).done(function(data){
                /* The delay has the purpose to show "refresh" feedback when a to consecutive changes success */
                $('div#alert-level-privacy-success').removeClass('hide',100);
                bom_password = new_password;
                show_chat(enable_chat);
                bom_last_updated = new Date();
            })
            .fail(function() {
                $('div#alert-level-privacy-failed').removeClass('hide',100);
            });
        });

        (function get_draw_details() {
            $.ajax({
                url : "{% url 'ws_get_draw_details' %}",
                method : "GET",
                data: { draw_id : "{{bom.pk}}" },
            }).done(function(data) {
                if(bom_last_updated < moment.utc(data.last_updated_time)){
                    window.location.reload();
                }
                for(var i=0; i<chats.length; i++) {
                    chats[i].messages = data.messages;
                }
            }).fail (function() {
                console.log("Error when retrieving draw details");
            });

            setTimeout(get_draw_details,2000);
        })();


    {% endif %}
    PublicDraw.lock_fields();
    $("#toss-button").click( function() {
        $.ajax({
            method : "GET",
            url   : "{% url 'ws_toss_draw' %}",
            data  : {draw_id : "{{bom.pk}}", draw_pass : "{{bom.password}}"}
        }).done(function (){
            window.location.reload();
        })
        .fail(function () {
            alert("{% trans 'There was an issue when tossing the draw :(' %}");
        });
    });


    $('.token-input').tokenfield({createTokensOnBlur:true});
{% endblock extra_jq_ready %}
{% block content %}
    {# breadcrumb to assist the creation of a public draw #}
    {% include "snippets/snippet_breadcrumb.html" %}
    <form class="clearfix" method="post">
        <!-- Draw Heading -->
        <div class="clearfix draw-heading">
            <a href="{% url 'index' %}" class="back-arrow col-xs-2 col-sm-2 text-center">
                <img src="{% static "img/back_arrow.png" %}"/>
            </a>
            <div class="col-xs-8 visible-xs"></div>
            {% if bom.is_shared %}
                {% if not bom.owner or bom.owner == user.pk %}
                    <a id="settings-button" data-toggle="modal" href="#public-draw-settings" title="{%trans 'Public draw settings'%}" class="public-draw-settings col-xs-2 col-sm-2 col-sm-push-8 text-center ">
                        <span id="public-draw-options" class="fa fa-gear fa-2x"></span>
                    </a>
                {% else %}
                    <div class="hidden-xs col-xs-2 col-sm-2 col-sm-push-8"></div>
                {% endif %}
            {% else %}
                    <a id="fav-button"
                    {% if bom.pk in user.favourites %}
                    data-active="y"
                    {% else %}
                    data-active="n"
                    {% endif %}
                    href="#" data-id="{{bom.pk}}" title="{%trans 'Add draw to favourites'%}" class="add-favourites col-xs-2 col-sm-2 col-sm-push-8 text-center ">
                        <span id="fav-loading" class="fa fa-spinner fa-pulse fa-2x hide"></span>
                    {% if bom.pk in user.favourites %}
                        <img src="{% static "img/star.png" %}"/>
                    {% else %}
                        <img src="{% static "img/star-o.png" %}"/>
                    {% endif %}
                    </a>
            {% endif %}
            <div id="draw-title-container" class="col-xs-12 col-sm-8 col-sm-pull-2 text-center">
                <textarea name="title" class="form-control autogrow draw-title-area text-center" rows="1">{{ bom.title|default:bom.DEFAULT_TITLE }}</textarea>
            </div>
        </div>
        <!-- End Draw Heading -->

        <div class="col-sm-8 col-sm-offset-2">
            {# pre-draw #}
                {% if bom.draw_type == "LinksSetsDraw" %}
                    <div class='alert alert-info' role='alert'>{%trans 'Separate items by commas. e.g: David S, Maria, Leo, ...'%}</div>
                {% endif %}
            {# end pre-draw #}
            <!-- Display Form -->
            <div class="step-configure">
                {% if bom.draw_type == "CoinDraw" %}
                    {% crispy draw draw.helper %}
                    <div class="text-center">
                        <input type="image" id="img-coin" src="{% static "img/img_coin/head.png" %}" name="coin">
                        <p>{% trans "Tap the coin to flip it." %}</p>
                        {% if result %}
                            <script>
                                coin.flip("{{ result.0.0 }}");
                            </script>
                        {% endif %}
                    </div>
                {% else %}
                    {% crispy draw draw.helper %}
                {% endif %}
            </div>
            <div class="col-xs-12 text-center">
                <!-- Button to toss -->
                <div class="row btn-row">
                    {%if not bom.owner or bom.owner == user.pk %}
                        <button id="toss-button" type="button" class="btn btn-success">{% trans 'Toss' %}</button>
                    {%else%}
                        <button id="toss-disabled-button" type="button" class="btn btn-success" disabled="disabled">{% trans 'Toss' %}</button>
                        <div class="alert alert-warning alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            {%trans 'Only the owner of the draw can toss. '%}[{{bom.owner}}]
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
    <!-- End Input Form -->
    <!-- Chat -->
    {% if bom.is_shared %}
        <div id="chat-frame" class="chat-inline col-xs-12 hidden"></div>
    {% endif %}
    <!-- End Chat -->

    <!-- Results -->
    {% if bom.results or bom.prev_draw  %}
        <div class="col-sm-8 col-sm-offset-2">
            <div class="row text-center accordion">
                {% for result in bom.results reversed %}
                {% with result.items as results%}
                    {% if results %}
                        <p class="h3">
                            {%trans 'Result' %}{{results|length|pluralize}}
                            <small class="visible-xs-inline">{{result.datetime|date:"d/m/y H:i:s"}}</small>
                            <small class="result-timestamp hidden-xs">{%trans ' generated on '%}{{result.datetime|date:"d M Y, H:i:s"}}</small>
                        </p>
                        <div class="result">
                        {% if bom.draw_type == "CardDraw" %}
                            <script>
                                var baseUrl = '{{ STATIC_URL }}' + "img/";
                                Card.setup(baseUrl, {{ results }});
                                Card.draw();
                            </script>
                        {% elif bom.draw_type == "CoinDraw" %}
                            {% if forloop.counter == 1 %}
                                <script>
                                    coin.flip("{{ results.0 }}");
                                </script>
                            {% endif %}
                            {% if results.0 == 'tail'%}
                                {% trans 'tail' %}
                            {% elif results.0 == 'head'%}
                                {% trans 'head' %}
                            {% else %}
                                {{results.0}}
                            {% endif %}
                        {% elif bom.draw_type == "DiceDraw" %}
                            {% if forloop.counter == 1 %}
                                <script>
                                    D6.dice({{ results }});
                                </script>
                            {% else %}
                                <script>
                                    D6.showPastResult({{ results}})
                                </script>
                            {% endif %}
                        {% elif bom.draw_type == "LinkSetsDraw" %}
                            <ul class="list-group">
                                {% for link in results %}
                                    <li class="list-group-item col-xs-12">
                                        {% for item in link %}
                                            <b>{{ item }}</b> {%if not forloop.last %} <span class="glyphicon glyphicon-minus" ></span> {%endif%}
                                        {% endfor %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% elif bom.draw_type == "LinkSetsDraw" %}
                            <ul class="list-group">
                                {% for item in results %}
                                    <li class="list-group-item col-xs-6 col-xs-offset-3">
                                        {{ item }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% elif bom.draw_type == "RandomNumberDraw" %}
                            <ul class="list-group">
                                {% for number in results %}
                                    <li class="list-group-item">
                                        {{ number }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}
                {% endfor %}
                <!-- Previous draw -->
                {% if bom.prev_draw %}
                    <p class="h3">{%trans 'Results' %}<small>{%trans ' generated before '%}</small></p>
                    <div >
                        {%trans 'The configuration of the draw was changed.'%}<br/>
                        {%trans 'This is the previous version: '%}<a href="{%url 'retrieve_draw' draw_id=bom.prev_draw %}">{{ bom.DEFAULT_TITLE }}</a>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
    <!-- End Results -->



                <div id="public-draw-settings" class="modal fade" tabindex="-1" style="display: none;" data-focus-on="input:first">
                    <div id="settings-general">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">{% trans "Public draw settings" %}</h4>
                        </div>
                        <div class="modal-body">
                            <ul id="" class="list-group">
                                <li id="edit-draw" class="settings-option list-group-item">{% trans "Edit draw configuration" %}</li>
                                <li id="invite" class="settings-option list-group-item">{% trans "Invite people" %}</li>
                                <li id="privacy" class="settings-option list-group-item">{% trans "Who can access your draw" %}</li>
                                <li class="settings-option list-group-item"><input type="checkbox" id="settings-show-in-public-list" {%if bom.show_in_public_list %}checked{%endif%}>{% trans "Show the draw in 'Recently created'" %}</li>
                                <li class="settings-option list-group-item"><input type="checkbox" id="settings-chat-enabled" {%if bom.enable_chat %}checked{%endif%}>{% trans "Enable chat" %}</li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" data-dismiss="modal" class="btn btn-default">{% trans "Cancel" %}</button>
                            <button id="save-settings" data-dismiss="modal" type="button" class="btn btn-primary">{% trans "Save" %}</button>
                        </div>
                    </div>
                    <div id="settings-edit-draw" class="settings-submenu hide">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">{% trans "Edit draw configuration" %}</h4>
                        </div>
                        <div class="modal-body">
                            {% trans "If you modify the draw's configuration the spectator will be notified about these changes. Are you sure you want to continue?" %}
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-default btn-settings-back">{% trans "Back" %}</a>
                            <a id="edit-draw-confirmation" class="btn btn-warning">{% trans "Edit draw" %}</a>
                        </div>
                    </div>
                    <div id="settings-invite" class="settings-submenu hide">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">{% trans "Invite people" %}</h4>
                        </div>
                        <div class="modal-body">
                            <p>{% trans "An invitation will arrive to the emails you introduce below" %}</p>
                            <div id="alert-invitation-failed" class="alert feedback alert-danger hide" role="alert">
                                <strong>{% trans "Ops!" %}</strong> {% trans "One or more emails contain errors..." %}
                            </div>
                            <div id="alert-invitation-success" class="alert feedback alert-success hide" role="alert">
                                <strong>{% trans "Everything went right!" %}</strong> {% trans "The invitation will arrive soon to these emails." %}
                            </div>
                            <input type="text" id="invite-emails" class="form-control" placeholder="{% trans "Type the emails here..."%}">
                            <a id="send-emails" data-id="{{bom.pk}}" class="btn btn-info">{% trans "Send emails" %}</a>
                            <p>{% trans "OR" %}</p>
                            <p data-toggle="tooltip" data-placement="top">{% trans "Share the link to the draw:" %}
                            <a>{% url 'retrieve_draw' draw_id=bom.pk %}</a>
                            </p>
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-default btn-settings-back">{% trans "Back" %}</a>
                            <button type="button" data-dismiss="modal" class="btn btn-default">{% trans "Close" %}</button>
                        </div>
                    </div>

                    <div id="settings-privacy" class="settings-submenu hide">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">{% trans "Restrict the access to your draw" %}</h4>
                        </div>
                        <div class="modal-body">
                            {% include "snippets/snippet_public_draw_privacy.html" %}
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-default btn-settings-back">{% trans "Back" %}</a>
                        </div>
                    </div>
                </div>

{% endblock %}

{% block right_column %}
    <div id="chat-column" class="chat-outside hidden"></div>
{% endblock right_column %}

